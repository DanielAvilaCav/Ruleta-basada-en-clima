<h1>üé∞ Sistema de Casino Ruleta</h1>

<div class="weather-box">
  <h2>üå§ Clima Actual</h2>
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <div>
      <p><strong>Condici√≥n:</strong> <%= @weather[:condition] %> (<%= @weather[:description] %>)</p>
      <p><strong>Temperatura:</strong> <%= @weather[:temperature] %>¬∞C</p>
      <p><strong>Humedad:</strong> <%= @weather[:humidity] %>%</p>
    </div>
    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px;">
      <small><strong>Efecto en Apuestas:</strong></small>
      <ul style="font-size: 0.9em; margin-left: 20px;">
        <% case @weather[:condition] 
           when 'Clear', 'Soleado' %>
           <li>‚òÄÔ∏è Despejado: ¬°Jugadores agresivos! </li>
        <% when 'Rain', 'Drizzle', 'Lluvia' %>
           <li>üåß Lluvia: Jugadores conservadores </li>
        <% when 'Snow', 'Nieve' %>
           <li>‚ùÑÔ∏è Nieve: Muy conservadores </li>
        <% else %>
           <li>‚òÅÔ∏è Nublado/Otro: Comportamiento normal</li>
        <% end %>
      </ul>
    </div>
  </div>
</div>
<div class="section" style="text-align: center; background-color: #2c3e50; color: white;">
  <h3>‚è≥ Pr√≥xima Ronda Autom√°tica en:</h3>
  <div id="countdown" style="font-size: 40px; font-weight: bold; color: #f1c40f;">Calculando...</div>
  <small>El sistema actualizar√° la p√°gina autom√°ticamente al llegar a cero.</small>
</div>

<script>
  // Definimos la funci√≥n por fuera para poder llamarla de varias formas
  function iniciarReloj() {
    console.log("‚è∞ Iniciando script del reloj...");
    
    var countdownElement = document.getElementById("countdown");
    if (!countdownElement) {
        console.log("‚ùå No encontr√© el elemento countdown");
        return;
    }

    // Usamos milisegundos puros (to_f) para evitar errores de fecha
    var lastRoundSeconds = <%= @last_round ? @last_round.created_at.to_f : (Time.now - 4.minutes).to_f %>;
    var lastRoundMs = lastRoundSeconds * 1000;
    var threeMinutesMs = 180 * 1000;
    var nextRoundMs = lastRoundMs + threeMinutesMs;

    // Limpiar intervalo anterior si existe
    if (window.timerInterval) clearInterval(window.timerInterval);

    function updateTimer() {
      var now = new Date().getTime();
      var distance = nextRoundMs - now;

      // Si ya pas√≥ el tiempo
      if (distance < 0) {
        countdownElement.innerHTML = "üîÑ Actualizando...";
        
        // Protecci√≥n: Si estamos MUY atrasados (servidor lento)
        if (distance < -5000) {
           console.log("‚ö†Ô∏è Muy atrasado, esperando 2s...");
           setTimeout(() => {
             // Intenta recargar con Turbo, si falla, usa recarga cl√°sica
             if (typeof Turbo !== 'undefined') {
                Turbo.visit(window.location.href, { action: "replace" });
             } else {
                window.location.reload();
             }
           }, 2000);
        } else {
           // Recarga r√°pida
           if (typeof Turbo !== 'undefined') {
              Turbo.visit(window.location.href, { action: "replace" });
           } else {
              window.location.reload();
           }
        }
        
        clearInterval(window.timerInterval);
        return;
      }

      // Matem√°ticas de tiempo
      var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      var seconds = Math.floor((distance % (1000 * 60)) / 1000);

      minutes = minutes < 10 ? "0" + minutes : minutes;
      seconds = seconds < 10 ? "0" + seconds : seconds;

      countdownElement.innerHTML = minutes + ":" + seconds;
    }

    // Arrancar
    updateTimer();
    window.timerInterval = setInterval(updateTimer, 1000);
    console.log("‚úÖ Reloj corriendo.");
  }

  // INTENTO 1: Modo Turbo (Rails 7/8)
  document.addEventListener("turbo:load", iniciarReloj);

  // INTENTO 2: Modo Cl√°sico (Por si Turbo falla)
  document.addEventListener("DOMContentLoaded", iniciarReloj);
</script>

<div class="section">
  <h2>+ Crear Nuevo Jugador</h2>
  <%= form_with(model: Player.new, local: true) do |form| %>
    <div style="display: flex; gap: 10px;">
      <%= form.text_field :name, placeholder: "Nombre del jugador", required: true, style: "margin-bottom: 0;" %>
      <%= form.submit "Crear Jugador" %>
    </div>
  <% end %>
</div>

<div class="section">
  <h2>üë• Jugadores Activos (<%= @players.count %>)</h2>
  <% if @players.any? %>
    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Balance Actual</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <% @players.each do |player| %>
          <tr>
            <td><strong><%= player.name %></strong></td>
            <td>
              $<%= number_with_delimiter(player.balance) %>
              <% if player.balance == 0 %>
                <span class="text-red">(Sin dinero üíÄ)</span>
              <% elsif player.balance <= 1000 %>
                <span style="color: orange;">(Cr√≠tico ‚ö†)</span>
              <% end %>
            </td>
            <td>
              <%= link_to "Editar", edit_player_path(player) %> |
              <%= button_to "Eliminar", player_path(player), method: :delete, style: "background:none; color:red; border:none; padding:0; display:inline; cursor:pointer;", form: {style: 'display:inline-block;'} %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p style="padding: 20px; text-align: center; color: #7f8c8d;">No hay jugadores. ¬°Crea uno arriba para comenzar!</p>
  <% end %>
</div>

<div class="section" style="text-align: center;">
  <h2>üé≤ Jugar Ronda</h2>
  <p>Todos los jugadores apostar√°n autom√°ticamente seg√∫n el clima.</p>
  <br>
  <%= button_to "¬°GIRAR RULETA!", rounds_play_path, method: :post, class: "play-btn" %>
</div>

<div class="section">
  <h2>üìú Historial de Rondas (√öltimas 20)</h2>
  <% if @rounds.any? %>
    <table>
      <thead>
        <tr>
          <th>Hora</th>
          <th>Clima</th>
          <th>Jugador</th>
          <th>Apost√≥ a</th>
          <th>Monto</th>
          <th>Sali√≥</th>
          <th>Resultado</th>
          <th>Ganancia Neta</th>
        </tr>
      </thead>
      <tbody>
        <% @rounds.each do |round| %>
          <tr>
            <td><%= round.created_at.strftime("%H:%M:%S") %></td>
            <td><%= round.weather_condition %></td>
            <td><%= round.player.name %></td>
            <td>
              <% color_style = case round.bet_color 
                 when 'Verde' then 'color:green;'
                 when 'Rojo' then 'color:red;'
                 else 'color:black;' end %>
              <span style="<%= color_style %> font-weight:bold;"><%= round.bet_color %></span>
            </td>
            <td>$<%= number_with_delimiter(round.bet_amount) %></td>
            <td>
               <% result_style = case round.wheel_result 
                 when 'Verde' then 'background:green; color:white; padding:2px 6px; border-radius:4px;'
                 when 'Rojo' then 'background:red; color:white; padding:2px 6px; border-radius:4px;'
                 else 'background:black; color:white; padding:2px 6px; border-radius:4px;' end %>
               <span style="<%= result_style %>"><%= round.wheel_result %></span>
            </td>
            <td>
              <% if round.result == 'Gan√≥' %>
                <span class="text-green">‚úî Gan√≥</span>
              <% else %>
                <span class="text-red">‚úò Perdi√≥</span>
              <% end %>
            </td>
            <td>
              <% if round.player_winnings > 0 %>
                <span class="text-green">+$<%= number_with_delimiter(round.player_winnings) %></span>
              <% else %>
                <span style="color: #bbb;">$0</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p>A√∫n no hay historial.</p>
  <% end %>
</div>